<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Director - Video Analysis + Transcription</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #ffffff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .video-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .video-display {
            width: 100%;
            height: auto;
            border-radius: 10px;
            background: #000;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
        }

        #videoFrame {
            width: 100%;
            height: auto;
            display: none;
        }

        .transcription-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .transcription-box {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            overflow-y: auto;
            max-height: 500px;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
        }

        .controls {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-stop {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .status {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
            font-weight: bold;
        }

        .status.connected {
            color: #4ade80;
        }

        .status.disconnected {
            color: #f87171;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4ade80;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        h2 {
            margin-bottom: 15px;
            color: #fbbf24;
            font-size: 1.5em;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ AI Director - Multi-Stream Video Analysis</h1>

        <div class="controls">
            <div class="button-group">
                <button class="btn-start" onclick="connectWebSocket()">Connect to Server</button>
                <button class="btn-stop" onclick="disconnectWebSocket()">Disconnect</button>
            </div>
            <div id="status" class="status disconnected">Disconnected</div>
        </div>

        <div class="main-grid">
            <div class="video-container">
                <h2>üìπ Video Stream</h2>
                <div class="video-display">
                    <img id="videoFrame" alt="Video stream">
                    <div id="videoPlaceholder">Waiting for video stream...</div>
                </div>
            </div>

            <div class="transcription-container">
                <h2>üîç Vision Analysis (SmolVLM)</h2>
                <div class="transcription-box" id="visionAnalysis" style="background: rgba(0, 120, 120, 0.2); border-left: 4px solid #00cc99; max-height: 250px;">
                    Waiting for video descriptions...
                </div>
                
                <h2 style="margin-top: 20px;">üé§ Audio Transcription (Moshi)</h2>
                <div class="transcription-box" id="transcription" style="background: rgba(120, 0, 120, 0.2); border-left: 4px solid #cc00cc; max-height: 250px;">
                    Waiting for audio transcription...
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="frameCount">0</div>
                <div class="stat-label">Frames Received</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="wordCount">0</div>
                <div class="stat-label">Words Transcribed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="fps">0</div>
                <div class="stat-label">FPS</div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let frameCount = 0;
        let wordCount = 0;
        let lastFrameTime = Date.now();
        let fpsValues = [];
        let transcriptionText = "";

        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log("Already connected");
                return;
            }

            // Auto-detect host: use page hostname if loaded via http, otherwise localhost
            const wsHost = window.location.hostname || 'localhost';
            ws = new WebSocket(`ws://${wsHost}:8765`);

            ws.onopen = () => {
                console.log("Connected to server");
                document.getElementById('status').textContent = "Connected to Server";
                document.getElementById('status').className = "status connected";
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    
                    if (message.type === 'video_frame') {
                        handleVideoFrame(message.data);
                    } else if (message.type === 'transcription') {
                        handleTranscription(message.text);
                    } else if (message.type === 'vision_analysis') {
                        handleVisionAnalysis(message);
                    }
                } catch (e) {
                    console.error("Error parsing message:", e);
                }
            };

            ws.onerror = (error) => {
                console.error("WebSocket error:", error);
                document.getElementById('status').textContent = "Connection Error";
                document.getElementById('status').className = "status disconnected";
            };

            ws.onclose = () => {
                console.log("Disconnected from server");
                document.getElementById('status').textContent = "Disconnected";
                document.getElementById('status').className = "status disconnected";
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function handleVideoFrame(frameData) {
            const img = document.getElementById('videoFrame');
            const placeholder = document.getElementById('videoPlaceholder');
            
            img.src = 'data:image/jpeg;base64,' + frameData;
            img.style.display = 'block';
            placeholder.style.display = 'none';
            
            // Update frame count
            frameCount++;
            document.getElementById('frameCount').textContent = frameCount;
            
            // Calculate FPS
            const now = Date.now();
            const timeDiff = (now - lastFrameTime) / 1000;
            const currentFps = 1 / timeDiff;
            fpsValues.push(currentFps);
            
            if (fpsValues.length > 10) {
                fpsValues.shift();
            }
            
            const avgFps = fpsValues.reduce((a, b) => a + b, 0) / fpsValues.length;
            document.getElementById('fps').textContent = avgFps.toFixed(1);
            
            lastFrameTime = now;
        }

        function handleVisionAnalysis(message) {
            const visionBox = document.getElementById('visionAnalysis');
            const frame = message.frame || '?';
            
            // Show ONLY the latest description (replace old ones)
            visionBox.textContent = `[Frame ${frame}] ${message.description}`;
            
            // Update word count for vision descriptions
            const words = message.description.split(/\s+/).filter(w => w.length > 0);
            document.getElementById('wordCount').textContent = words.length;
        }

        function handleTranscription(text) {
            transcriptionText += text;
            
            // Count words
            const words = transcriptionText.trim().split(/\s+/).filter(w => w.length > 0);
            wordCount = words.length;
            document.getElementById('wordCount').textContent = wordCount;
            
            // Update transcription display
            const transcriptionBox = document.getElementById('transcription');
            transcriptionBox.textContent = transcriptionText;
            
            // Auto-scroll to bottom
            transcriptionBox.scrollTop = transcriptionBox.scrollHeight;
        }

        // Auto-connect on page load
        window.onload = () => {
            setTimeout(connectWebSocket, 500);
        };

        // Clean up on page unload
        window.onbeforeunload = () => {
            disconnectWebSocket();
        };
    </script>
</body>
</html>
